"use strict";(self.webpackChunksfmcify=self.webpackChunksfmcify||[]).push([[7154],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(a),m=o,h=d["".concat(s,".").concat(m)]||d[m]||u[m]||i;return a?n.createElement(h,r(r({ref:t},p),{},{components:a})):n.createElement(h,r({ref:t},p))}));function m(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},8274:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var n=a(7462),o=(a(7294),a(3905));const i={id:"ManageSpamComplaints",title:"How to manage spam complaints on Salesforce Marketing Cloud",sidebar_label:"Manage Spam Complaints",tags:["Spam complaints","GDPR","AMPScript","MarketingCloud Connect"]},r=void 0,l={unversionedId:"SFMC AMPScript/ManageSpamComplaints",id:"SFMC AMPScript/ManageSpamComplaints",title:"How to manage spam complaints on Salesforce Marketing Cloud",description:"There are several factors to take into consideration for a successful landing in the inbox. Open rates, bounce rates, ctr and other metrics all reveal a lot about your emails reputation for ISPs and your clients. An important factor we need to keep an eye on is spam complaints rate because it can easily damage your domains and IPs hardly earned reputation.",source:"@site/docs/SFMC AMPScript/ManageSpamComplaints.md",sourceDirName:"SFMC AMPScript",slug:"/SFMC AMPScript/ManageSpamComplaints",permalink:"/docs/SFMC AMPScript/ManageSpamComplaints",draft:!1,tags:[{label:"Spam complaints",permalink:"/docs/tags/spam-complaints"},{label:"GDPR",permalink:"/docs/tags/gdpr"},{label:"AMPScript",permalink:"/docs/tags/amp-script"},{label:"MarketingCloud Connect",permalink:"/docs/tags/marketing-cloud-connect"}],version:"current",frontMatter:{id:"ManageSpamComplaints",title:"How to manage spam complaints on Salesforce Marketing Cloud",sidebar_label:"Manage Spam Complaints",tags:["Spam complaints","GDPR","AMPScript","MarketingCloud Connect"]},sidebar:"tutorialSidebar",previous:{title:"Data Privacy Manager & SFMC",permalink:"/docs/SFMC AMPScript/DataPrivacyManagerAndSFMC"},next:{title:"SFMC API",permalink:"/docs/category/sfmc-api"}},s={},c=[{value:"SFMC account architecture",id:"sfmc-account-architecture",level:2},{value:"Why is this architecture not convenient?",id:"why-is-this-architecture-not-convenient",level:3},{value:"FeedBack Loops",id:"feedback-loops",level:2},{value:"ISP Feedback Loops for Marketing Cloud",id:"isp-feedback-loops-for-marketing-cloud",level:3},{value:"Do all ISPs have Feedback loops?",id:"do-all-isps-have-feedback-loops",level:3},{value:"I can\u2019t see Yahoo on the list, what about them?",id:"i-cant-see-yahoo-on-the-list-what-about-them",level:3},{value:"What about Gmail?",id:"what-about-gmail",level:3},{value:"How to handle complaints on Salesforce Marketing Cloud?",id:"how-to-handle-complaints-on-salesforce-marketing-cloud",level:2},{value:"Getting today\u2019s complaints from Complaints data view",id:"getting-todays-complaints-from-complaints-data-view",level:3},{value:"SQL Query to get complaints",id:"sql-query-to-get-complaints",level:4},{value:"Automation to update consents on Sales Cloud",id:"automation-to-update-consents-on-sales-cloud",level:3},{value:"Run AMScript in a Script Activity in Automation Studio",id:"run-amscript-in-a-script-activity-in-automation-studio",level:4},{value:"Code Snippet code",id:"code-snippet-code",level:4},{value:"Script activity code",id:"script-activity-code",level:4}],p={toc:c};function u(e){let{components:t,...i}=e;return(0,o.kt)("wrapper",(0,n.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"There are several factors to take into consideration for a successful landing in the inbox. Open rates, bounce rates, ctr and other metrics all reveal a lot about your emails reputation for ISPs and your clients. An important factor we need to keep an eye on is ",(0,o.kt)("strong",{parentName:"p"},"spam complaints rate")," because it can easily damage your domains and IPs hardly earned reputation."),(0,o.kt)("p",null,"In this article, you will learn how to manage email complaints on a multi-business unit organisation on Salesforce Marketing Cloud when using a custom solution for managing consents."),(0,o.kt)("p",null,"Before digging into the subject, I want to give an overview about the architecture of the Marketing Cloud account we are using."),(0,o.kt)("h2",{id:"sfmc-account-architecture"},"SFMC account architecture"),(0,o.kt)("p",null,"We have two brands we\u2019re going to call ",(0,o.kt)("strong",{parentName:"p"},"Brand A")," and ",(0,o.kt)("strong",{parentName:"p"},"Brand B")," that are running on a multi-org account. At the beginning of the project, we did not have longterm visibility about the client\u2019s needs. So, we decided to work with a basic and simple architecture:"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"SFMC Architecture connected to Sales Cloud",src:a(7518).Z,width:"600",height:"425"})),(0,o.kt)("p",null,"A parent Business Unit, the only one that was used at that time: Brand A. A second BU, which is a contract\u2019s bonus from Salesforce."),(0,o.kt)("h3",{id:"why-is-this-architecture-not-convenient"},"Why is this architecture not convenient?"),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"I would not recommend using this architecture for many reasons. Some are explained below, and some are not. What I suggest is using the parent BU as an Admin BU and use child BUs for your brands if you have many. This way, you will avoid a lot of headaches in the future..")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"We can\u2019t use the business-level unsubscribes standard functionality at the parent BU. Remember that our parent BU represents our Brand A.")),(0,o.kt)("p",null,"This functionality is available at ",(0,o.kt)("inlineCode",{parentName:"p"},"Properties")," settings of a Business unit. We have to choose between these two options:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Subscribers will be unsubscribed from all business units in the Enterprise"),(0,o.kt)("li",{parentName:"ol"},"Subscribers will be unsubscribed from this business unit only")),(0,o.kt)("p",null,"The problem is, we don\u2019t have a choice at the parent BU. SFMC forces you to choose the first option. This will result in an unwanted behaviour: "),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"A contact will no longer receive emails from ",(0,o.kt)("strong",{parentName:"p"},"Brand B")," if he unsubscribes from a ",(0,o.kt)("strong",{parentName:"p"},"Brand\u2019s A")," email.")),(0,o.kt)("h2",{id:"feedback-loops"},"FeedBack Loops"),(0,o.kt)("p",null,"There are two ways a recipient can use to unsubscribe from emails. He can either click the unsubscribe link on the email, or make use of the \u201cMark as spam\u201d button in the inbox."),(0,o.kt)("p",null,"It\u2019s important to understand how spam complaints are handled by Marketing Cloud because, depending on how we are managing consents, we might adjust the standard handling process."),(0,o.kt)("h3",{id:"isp-feedback-loops-for-marketing-cloud"},"ISP Feedback Loops for Marketing Cloud"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"A feedback loop (FBL) is a service provided by some ISPs to let recipients inform senders that a given email is unwanted (by letting the user hit the \u201cThis is spam\u201d button on his email client).")),(0,o.kt)("p",null,"After the click on this button, an \u201cFBL\u201d complaint is sent back to Marketing Cloud. Once processed, the recipient will be marked as unsubscribed on AllSubscribers and the complaint is logged in the ",(0,o.kt)("a",{parentName:"p",href:"https://help.salesforce.com/articleView?id=mc_as_data_view_complaint.htm&type=5"},"Complaint data view"),"."),(0,o.kt)("h3",{id:"do-all-isps-have-feedback-loops"},"Do all ISPs have Feedback loops?"),(0,o.kt)("p",null,"As stated in ",(0,o.kt)("a",{parentName:"p",href:"https://help.salesforce.com/articleView?id=000353531&type=1&mode=1"},"this article"),", All Marketing Cloud clients are signed up for the ISP feedback loops below automatically. Salesforce Marketing Cloud bulk-registers all of its sending IP address ranges with these ISP feedback loops:"),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Bluetie (Excite), Comcast, Cox, Fastmail, Microsoft Hotmail, Italia Online, La Poste, Liberty Global, Locaweb, Mail.ru, OpenSRS (Tucows), Rackspace (Mailtrust), Seznam, Synacor, Telenor, Telstra, Terra, UOL (Brazil), USA.net, XS4ALL, and Yandex")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"We see Microsoft Hotmail on the list, but it\u2019s important to know that FBL for ",(0,o.kt)("em",{parentName:"p"},"Outlook Desktop version")," is not offered by Microsoft. ",(0,o.kt)("strong",{parentName:"p"},"This was confirmed by the SFMC\u2019s support"),".")),(0,o.kt)("h3",{id:"i-cant-see-yahoo-on-the-list-what-about-them"},"I can\u2019t see Yahoo on the list, what about them?"),(0,o.kt)("p",null,"As explained in ",(0,o.kt)("a",{parentName:"p",href:"https://help.salesforce.com/articleView?language=en_US&type=1&mode=1&id=000312472"},"this article"),", Yahoo Mail\u2019s Feedback Loop requires that all mail be signed with DKIM. Which means, we need to have ",(0,o.kt)("strong",{parentName:"p"},"Private Domain")," or ",(0,o.kt)("strong",{parentName:"p"},"Sender Authentication Package"),"\xa0on our account because it\u2019s necessary to sign all mail with DKIM (DomainKeys Identified Mail) authentication."),(0,o.kt)("p",null,"In our case, we have SAP and private domains on both BUs. We followed the statement in the article saying:"),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"If you have a sending domain configured as a Private Domain with Marketing Cloud, please reach out to support to have the domain registered for the Yahoo FBL.")),(0,o.kt)("p",null,"We\u2019ve created an email asking the support to activate this feature, but it appears that it\u2019s enabled automatically for private domains as well as SAP. Anyway, I recommend you asking them to enable it for you, who knows .."),(0,o.kt)("h3",{id:"what-about-gmail"},"What about Gmail?"),(0,o.kt)("p",null,"Google has a different mechanism that does not function like a standard FBL. They call it GFL (Gmail Feedback Loop). It offers a high level reputation related statistics through their tool \u201cGmail Postmaster Tools\u201d. Unlike other ISPs, SFMC does not register its clients domains with Gmail Postmaster Tools. "),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"You can check this ",(0,o.kt)("a",{parentName:"p",href:"https://help.salesforce.com/articleView?id=000313363&type=1&language=en_US"},"enrollment guide")," to register for GFL. ")),(0,o.kt)("p",null,"I\u2019ve done some tests (we are in 2018), and it appears that if a recipient clicks on the \u201cMark as spam\u201d button, it will not be logged in ",(0,o.kt)("inlineCode",{parentName:"p"},"Complaints")," data view, but unlike what it is said in the SFMC documentation, the recipient will be ",(0,o.kt)("strong",{parentName:"p"},"marked as unsubscribed")," in AllSubscribers."),(0,o.kt)("h2",{id:"how-to-handle-complaints-on-salesforce-marketing-cloud"},"How to handle complaints on Salesforce Marketing Cloud?"),(0,o.kt)("p",null,"Handling complaints depends on our SFMC architecture and how are we handling consents. In our case, we moved consents logic outside of AllSubscribers. "),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"You can check out ",(0,o.kt)("a",{parentName:"p",href:"/docs/SFMC%20AMPScript/DataPrivacyManagerAndSFMC"},"this article")," where I explain a way to manage Data Privacy between Sales and Marketing Clouds.")),(0,o.kt)("p",null,"We are using a Sales Cloud plugin called Data Privacy Manager to handle consents. A custom field is created on Lead, Account and Contact objects. Each consent is represented by a unique auto-generated six digit code. For example, if we have two types of communications for our contacts, let\u2019s call them\xa0",(0,o.kt)("inlineCode",{parentName:"p"},"Newsletter"),"\xa0and\xa0",(0,o.kt)("inlineCode",{parentName:"p"},"SpecialOffers"),", they will have the ids 100001 & 100002. These values are concatenated into the field and separated by a comma."),(0,o.kt)("p",null,"On the SFMC side, each consent will be represented by a boolean field on our ",(0,o.kt)("inlineCode",{parentName:"p"},"Consent")," data extension. It should look like below:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Field Name"),(0,o.kt)("th",{parentName:"tr",align:null},"Field Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Length"),(0,o.kt)("th",{parentName:"tr",align:null},"Default Value"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"SubscriberKey"),(0,o.kt)("td",{parentName:"tr",align:null},"Text"),(0,o.kt)("td",{parentName:"tr",align:null},"18"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"NewsletterEmail_Consent"),(0,o.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,o.kt)("td",{parentName:"tr",align:null},"False"),(0,o.kt)("td",{parentName:"tr",align:null},"False")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"SpecialOffersEmail_Consent"),(0,o.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,o.kt)("td",{parentName:"tr",align:null},"False"),(0,o.kt)("td",{parentName:"tr",align:null},"False")))),(0,o.kt)("h3",{id:"getting-todays-complaints-from-complaints-data-view"},"Getting today\u2019s complaints from Complaints data view"),(0,o.kt)("p",null,"Salesforce Marketing Cloud provides a data view to check ",(0,o.kt)("a",{parentName:"p",href:"https://help.salesforce.com/articleView?id=mc_as_data_view_complaint.htm&type=5"},"complaints")," data related to emails from our BUs. By querying this data view, we can get spam complaints from our subscribers about our emails sends for the last six months."),(0,o.kt)("p",null,"To get today\u2019s complaints, we will be creating an automation with two activities. An SQL query to get data, and a Script activity to update consents on Sales Cloud."),(0,o.kt)("p",null,"The automation will be scheduled to run daily at 5AM. The schedule time depends on other automations on our account. "),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"I would suggest scheduling this automation early in the morning so that \u201ccomplainers\u201d are excluded from that day\u2019s communications as well.")),(0,o.kt)("p",null,(0,o.kt)("strong",{parentName:"p"},"BRAND_A_COMPLAINTS Data Extension")),(0,o.kt)("p",null,"We need a data extension to store complaints in our socle. Let\u2019s go with this format:"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Field Name"),(0,o.kt)("th",{parentName:"tr",align:null},"Field Type"),(0,o.kt)("th",{parentName:"tr",align:null},"Length"),(0,o.kt)("th",{parentName:"tr",align:null},"Default Value"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"SubscriberKey"),(0,o.kt)("td",{parentName:"tr",align:null},"Text"),(0,o.kt)("td",{parentName:"tr",align:null},"18"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"JobID"),(0,o.kt)("td",{parentName:"tr",align:null},"Number"),(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Email_Name"),(0,o.kt)("td",{parentName:"tr",align:null},"Text"),(0,o.kt)("td",{parentName:"tr",align:null},"500"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Domain"),(0,o.kt)("td",{parentName:"tr",align:null},"Text"),(0,o.kt)("td",{parentName:"tr",align:null},"128"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"AccountID"),(0,o.kt)("td",{parentName:"tr",align:null},"Number"),(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"OYBAccountID"),(0,o.kt)("td",{parentName:"tr",align:null},"Text"),(0,o.kt)("td",{parentName:"tr",align:null},"50"),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Event_Date"),(0,o.kt)("td",{parentName:"tr",align:null},"Date"),(0,o.kt)("td",{parentName:"tr",align:null}),(0,o.kt)("td",{parentName:"tr",align:null})),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"Secret"),(0,o.kt)("td",{parentName:"tr",align:null},"Number"),(0,o.kt)("td",{parentName:"tr",align:null},"1"),(0,o.kt)("td",{parentName:"tr",align:null})))),(0,o.kt)("p",null,"You should be asking, why do we need the OYBAccountID and Secret fields? Good question. In our case, we have two business units, each business unit represents a different brand and have its own domains and IP addresses. And since AllSubscribers is shared between BUs as well as Complaints data view, complaints from all business units will be regrouped in this data view, ",(0,o.kt)("em",{parentName:"p"},(0,o.kt)("strong",{parentName:"em"},"we don\u2019t want a subscriber that complaints about a BrandA\u2019s email to be considered as a BrandB\u2019s complainer."))),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("inlineCode",{parentName:"p"},"AllSubscribers")," is shared between all BUs of an SFMC instance. The same applies for ",(0,o.kt)("inlineCode",{parentName:"p"},"Complaints")," data view, complaints from all business units will be regrouped in this data view.")),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},(0,o.kt)("strong",{parentName:"p"},"OYBAccountID")," is a field in our data view that is populated automatically by Marketing Cloud ",(0,o.kt)("strong",{parentName:"p"},"only")," if the complaint is from a child BU. Hence, if a complaint is from our child BU, we can use OYBAccountID to determine from which consents we need to unsubscribe the complainer.")),(0,o.kt)("p",null,"I\u2019ll be explaining the utility of \u201cSecret\u201d field later on."),(0,o.kt)("h4",{id:"sql-query-to-get-complaints"},"SQL Query to get complaints"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n\ncomp.SubscriberKey,\ncomp.jobid, \neventdate, \nemailname,\nDomain,\nISNULL(comp.OYBAccountID,comp.AccountID) as OYBAccountID,\ncomp.AccountID\n\nFROM _Complaint comp\nINNER JOIN _job j ON comp.jobid = j.jobid\n\n\nAND convert(date, comp.eventdate) >= dateadd(day, datediff(day, 0, getdate()) - 1, 0)  \nAND convert(date, comp.eventdate) < getdate()\nAND ((OYBAccountID IS not null and OYBAccountID = 50000XXXX) OR (OYBAccountID IS null))\n")),(0,o.kt)("p",null,"When ",(0,o.kt)("strong",{parentName:"p"},"OYBAccountID")," is null, which will always be the case when running the query from the parent BU, the ISNULL function populates it with the AccountID. We use ",(0,o.kt)("inlineCode",{parentName:"p"},"Datediff")," function to get yesterday\u2019s date and compare it with today\u2019s date."),(0,o.kt)("h3",{id:"automation-to-update-consents-on-sales-cloud"},"Automation to update consents on Sales Cloud"),(0,o.kt)("h4",{id:"run-amscript-in-a-script-activity-in-automation-studio"},"Run AMScript in a Script Activity in Automation Studio"),(0,o.kt)("p",null,"After marking an email as spam, the contact is marked as Unsubscribed in AllSubscribers. This is not enough in our case because we are relying on a data extension to manage our contacts\u2019 consents. We need to update consents on Sales Cloud using the mechanism described ",(0,o.kt)("a",{parentName:"p",href:"/docs/SFMC%20AMPScript/DataPrivacyManagerAndSFMC"},"here"),"."),(0,o.kt)("p",null,"To unsubscribe a contact, we need to use the AMPScript function ",(0,o.kt)("strong",{parentName:"p"},"CreateSalesforceObject")," to create a Task on Sales Cloud with specific texts in the subject and comments fields."),(0,o.kt)("p",null,"But, as you might already know, Script activities work only with SSJS. Hence, we have two options here: use AMPScript directly in our script activity using concatenation and TreatAsContent function (which I recommend only if your code is simple and not too long) . Or, using this way:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create a Code Snippet content block in Content Builder"),(0,o.kt)("li",{parentName:"ul"},"Add our AMPScript to it"),(0,o.kt)("li",{parentName:"ul"},"Execute the AMPScript from the Script Activity using SSJS\u2019s platform function ",(0,o.kt)("strong",{parentName:"li"},"ContentBlockByKey"))),(0,o.kt)("h4",{id:"code-snippet-code"},"Code Snippet code"),(0,o.kt)("p",null,"This code starts with a lookup on our ",(0,o.kt)("inlineCode",{parentName:"p"},"BRAND_A_COMPLAINTS")," data extension hosting all our complaints of the day. "),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Use the field ",(0,o.kt)("strong",{parentName:"p"},"Secret"),", which is a number field with a default value of 1, as an always true condition in a lookup to get all records of a data extension. It\u2019s a sort of a workaround.")),(0,o.kt)("p",null,"Then, we are getting the subscriberkey of the complainer and creating a task on Sales Cloud with the specific texts in the subject and comments. In this case, we are unsubscribing contacts from all email communications."),(0,o.kt)("p",null,"At the end, we are logging subscriberkeys and the date of the unsubscriptions."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'%%[ var @rows, @row, @rowCount, @subKey, @counter\n\nset @rows = LookupRows("BRANDA_COMPLAINTS","OYBAccountID","50000XXXX","Secret", 1) \nset @rowCount = rowcount(@rows) \n\nif @rowCount > 0 then \nfor @counter = 1 to @rowCount do \n  set @row = row(@rows, @counter) \n  set @subKey = field(@row,"SubscriberKey") \n  set @created_taskId= CreateSalesforceObject(\'Task\',3,\'WhoId\', @subKey, \'Subject\', \'Datapm:Unsubscribe\', \'Description\', \'{"channel":"email"}\')\nnext\nendif\n\nInsertDE("COMPLAINTS_LOG","SubscriberKey", @subKey,"Event_Date", FormatDate(Now(),"iso"))\n]%%\n')),(0,o.kt)("h4",{id:"script-activity-code"},"Script activity code"),(0,o.kt)("p",null,"In the script activity, we are using the ",(0,o.kt)("inlineCode",{parentName:"p"},"ContentBlockByKey")," function to execute our AMPScript. Don\u2019t forget to replace ",(0,o.kt)("inlineCode",{parentName:"p"},"YOUR_CONTENTBLOCK_KEY")," by your Code Snippet key. We can use ",(0,o.kt)("inlineCode",{parentName:"p"},"ContentBlockByName")," or ",(0,o.kt)("inlineCode",{parentName:"p"},"ContentBlockById")," functions as well."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'<script runat="server">\n var ampscriptCode = Platform.Function.ContentBlockByKey("YOUR_CONTENTBLOCK_KEY");\n<\/script>\n')),(0,o.kt)("p",null,"We discovered a ",(0,o.kt)("strong",{parentName:"p"},"technical")," way to handle complaints when using a custom consents management solution. We need to understand that if the percentage is high (it is said that a bad rate would be above 0.3%), we might consider checking our emailing strategy (content and frequency) because at the end, the source of the problem is what needs to be fixed."),(0,o.kt)("p",null,"Next time, I\u2019ll be writing about how to handle complaints from ISPs that are not handled by default by Marketing Cloud. Let me know if this would be interesting, and don\u2019t forget, all comments and suggestions are welcome."))}u.isMDXComponent=!0},7518:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/Architecture-bf6499ad65a7dd5a1d18d994c818f261.png"}}]);